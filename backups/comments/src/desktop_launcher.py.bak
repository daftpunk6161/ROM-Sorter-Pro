#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ROM Sorter Pro - Desktop-Integration Startpunkt
Phase 1 Implementation: Desktop-Optimierung und Integration

Dieses Modul dient als Haupteinstiegspunkt für die neue Desktop-Version
mit Qt-UI und integriertem High-Performance-Scanner.
"""

import os
import sys
import logging
import argparse
from pathlib import Path

# Konfiguriere Logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler(os.path.join('logs', f'rom_sorter_{Path(__file__).stem}.log'))
    ]
)

logger = logging.getLogger(__name__)

def ensure_dependencies():
    """Stellt sicher, dass alle notwendigen Abhängigkeiten installiert sind."""
    qt_available = False

    # Versuche zuerst PyQt6 zu importieren
    try:
        import PyQt6
        logger.info("PyQt6 ist installiert")
        qt_available = True
    except ImportError:
        logger.warning("PyQt6 ist nicht installiert - versuche PyQt5 als Alternative...")

        # Versuche PyQt5 als Fallback
        try:
            import PyQt5
            logger.info("PyQt5 ist als Fallback installiert")
            qt_available = True
        except ImportError:
            logger.error("Weder PyQt6 noch PyQt5 ist installiert - versuche Installation...")

            try:
                import subprocess

                # Versuche zuerst PyQt6 zu installieren
                try:
                    logger.info("Versuche PyQt6 zu installieren...")
                    subprocess.check_call([sys.executable, "-m", "pip", "install", "PyQt6"])
                    logger.info("PyQt6 wurde erfolgreich installiert")
                    qt_available = True
                except Exception as e:
                    logger.warning(f"PyQt6 Installation fehlgeschlagen: {e}")
                    logger.warning("Versuche PyQt5 zu installieren...")

                    # Als Fallback PyQt5 versuchen
                    try:
                        subprocess.check_call([sys.executable, "-m", "pip", "install", "PyQt5"])
                        logger.info("PyQt5 wurde als Fallback erfolgreich installiert")
                        qt_available = True
                    except Exception as e2:
                        logger.error(f"PyQt5 Installation fehlgeschlagen: {e2}")
                        logger.error("Bitte installiere PyQt6 oder PyQt5 manuell mit: pip install PyQt6")
            except Exception as e:
                logger.error(f"Fehler beim Installationsversuch: {e}")

    return qt_available

def main():
    """Hauptfunktion zum Starten der Anwendung."""
    parser = argparse.ArgumentParser(description="ROM Sorter Pro - Desktop Edition")
    parser.add_argument('--debug', action='store_true', help='Debug-Modus aktivieren')
    parser.add_argument('--config', help='Pfad zur Konfigurationsdatei')
    parser.add_argument('--cli', action='store_true', help='Startet im CLI-Modus ohne GUI')
    args = parser.parse_args()

    # Setze Log-Level basierend auf Debug-Flag
    if args.debug:
        logging.getLogger().setLevel(logging.DEBUG)
        logger.debug("Debug-Modus aktiviert")

    # Stelle sicher, dass das logs-Verzeichnis existiert
    os.makedirs('logs', exist_ok=True)

    # Überprüfe und installiere Abhängigkeiten, wenn nicht im CLI-Modus
    if not args.cli and not ensure_dependencies():
        logger.warning("Qt-Abhängigkeiten fehlen, starte im CLI-Modus als Fallback")
        args.cli = True  # Setze CLI-Modus als Fallback

    try:
        # Füge Hauptverzeichnis zum Python-Pfad hinzu, falls nötig
        current_dir = Path(__file__).parent.resolve()  # src/
        root_dir = current_dir.parent.resolve()       # Projektroot

        # Füge beide Verzeichnisse zum Pfad hinzu
        for directory in [str(root_dir), str(current_dir)]:
            if directory not in sys.path:
                sys.path.insert(0, directory)
                logger.debug(f"Verzeichnis zum Python-Pfad hinzugefügt: {directory}")

        # Starte die Anwendung entsprechend dem gewählten Modus
        if args.cli:
            # CLI-Modus: Starte die Konsolenversion
            from src.cli.console_interface import start_cli_mode
            logger.info("Starte ROM Sorter Pro CLI-Edition...")
            start_cli_mode()
        else:
            # GUI-Modus: Starte die Desktop-UI
            from src.ui.qt.integrated_window import start_integrated_ui
            logger.info("Starte ROM Sorter Pro Desktop-Edition...")
            start_integrated_ui()

    except ImportError as e:
        logger.error(f"Fehler beim Importieren der Module: {e}")
        logger.error("Bitte stelle sicher, dass alle Abhängigkeiten installiert sind")
        sys.exit(1)
    except Exception as e:
        logger.error(f"Unerwarteter Fehler: {e}")
        import traceback
        logger.error(traceback.format_exc())
        sys.exit(1)

if __name__ == "__main__":
    main()
