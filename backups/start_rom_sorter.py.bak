#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ROM Sorter Pro - Startup Script

This script starts the ROM Sorter Pro application.
It checks the environment and starts the appropriate UI.
"""

import os
import sys
import logging
import argparse
import platform
from pathlib import Path

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    filename='logs/rom_sorter_startup.log',
    filemode='a'
)
logger = logging.getLogger(__name__)

def check_environment():
    """Checks the runtime environment."""
    # Check Python version
    py_version = platform.python_version_tuple()
    if int(py_version[0]) < 3 or (int(py_version[0]) == 3 and int(py_version[1]) < 8):
        print(f"WARNING: Python {platform.python_version()} detected. ROM Sorter Pro requires Python 3.8 or higher.")
        logger.warning(f"Outdated Python version: {platform.python_version()}")
    
    # Detect operating system
    os_name = platform.system()
    logger.info(f"Operating system: {os_name} {platform.version()}")
    
    # Check directories
    required_dirs = ["logs", "rom_databases", "temp"]
    for directory in required_dirs:
        os.makedirs(directory, exist_ok=True)
    
    return True

def parse_arguments():
    """Parses command line arguments."""
    parser = argparse.ArgumentParser(description="ROM Sorter Pro - Universal ROM Organizer")
    parser.add_argument("--cli", action="store_true", help="Start in command line mode")
    parser.add_argument("--scan", metavar="DIR", help="Directly scan the specified directory")
    parser.add_argument("--version", action="store_true", help="Show version information")
    parser.add_argument("--debug", action="store_true", help="Enable debug mode")
    
    return parser.parse_args()

def main():
    """Main function to start the application."""
    logger.info("Starting ROM Sorter Pro...")
    
    # Check environment
    if not check_environment():
        sys.exit(1)
    
    # Parse command line arguments
    args = parse_arguments()
    
    if args.version:
        print("ROM Sorter Pro v2.1.5")
        print("Copyright (c) 2025")
        sys.exit(0)
    
    if args.debug:
        logging.getLogger().setLevel(logging.DEBUG)
        logger.debug("Debug mode enabled")
    
    # Try to add the src directory to the Python path
    src_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), "src"))
    if src_dir not in sys.path:
        sys.path.insert(0, src_dir)
    
    # Start the application in the desired mode
    try:
        if args.cli:
            logger.info("Starting in CLI mode...")
            from src.cli.console_interface import start_cli
            start_cli(scan_dir=args.scan)
        else:
            logger.info("Starting in GUI mode...")
            from src.main import main as start_gui
            start_gui(scan_dir=args.scan)
            
    except ImportError as e:
        logger.error(f"Error importing modules: {e}")
        print(f"Error: {e}")
        print("Please run 'python install_dependencies.py' to install all required dependencies.")
        sys.exit(1)
    except Exception as e:
        logger.error(f"Error starting the application: {e}")
        print(f"Error: {e}")
        sys.exit(1)
    
    logger.info("ROM Sorter Pro terminated.")

if __name__ == "__main__":
    main()
